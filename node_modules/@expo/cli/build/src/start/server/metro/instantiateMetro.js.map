{"version":3,"sources":["../../../../../src/start/server/metro/instantiateMetro.ts"],"sourcesContent":["import { getConfig } from '@expo/config';\nimport { MetroDevServerOptions } from '@expo/dev-server';\nimport chalk from 'chalk';\nimport http from 'http';\nimport Metro from 'metro';\nimport { Terminal } from 'metro-core';\n\nimport { Log } from '../../../log';\nimport { getMetroProperties } from '../../../utils/analytics/getMetroProperties';\nimport { createDebuggerTelemetryMiddleware } from '../../../utils/analytics/metroDebuggerMiddleware';\nimport { logEventAsync } from '../../../utils/analytics/rudderstackClient';\nimport { env } from '../../../utils/env';\nimport { createDevServerMiddleware } from '../middleware/createDevServerMiddleware';\nimport { getPlatformBundlers } from '../platformBundlers';\nimport { MetroTerminalReporter } from './MetroTerminalReporter';\nimport { importExpoMetroConfigFromProject, importMetroFromProject } from './resolveFromProject';\nimport { withMetroMultiPlatformAsync } from './withMetroMultiPlatform';\n\n// From expo/dev-server but with ability to use custom logger.\ntype MessageSocket = {\n  broadcast: (method: string, params?: Record<string, any> | undefined) => void;\n};\n\n/** The most generic possible setup for Metro bundler. */\nexport async function instantiateMetroAsync(\n  projectRoot: string,\n  options: Omit<MetroDevServerOptions, 'logger'>\n): Promise<{\n  server: http.Server;\n  middleware: any;\n  messageSocket: MessageSocket;\n}> {\n  let reportEvent: ((event: any) => void) | undefined;\n\n  const Metro = importMetroFromProject(projectRoot);\n  const ExpoMetroConfig = importExpoMetroConfigFromProject(projectRoot);\n\n  const terminal = new Terminal(process.stdout);\n  const terminalReporter = new MetroTerminalReporter(projectRoot, terminal);\n\n  const reporter = {\n    update(event: any) {\n      terminalReporter.update(event);\n      if (reportEvent) {\n        reportEvent(event);\n      }\n    },\n  };\n\n  let metroConfig = await ExpoMetroConfig.loadAsync(projectRoot, { reporter, ...options });\n\n  // TODO: When we bring expo/metro-config into the expo/expo repo, then we can upstream this.\n  const { exp } = getConfig(projectRoot, {\n    skipSDKVersionRequirement: true,\n    skipPlugins: true,\n  });\n\n  const platformBundlers = getPlatformBundlers(exp);\n  metroConfig = await withMetroMultiPlatformAsync(projectRoot, metroConfig, platformBundlers);\n\n  logEventAsync('metro config', getMetroProperties(projectRoot, exp, metroConfig));\n\n  const {\n    middleware,\n    attachToServer,\n\n    // New\n    websocketEndpoints,\n    eventsSocketEndpoint,\n    messageSocketEndpoint,\n  } = createDevServerMiddleware(projectRoot, {\n    port: metroConfig.server.port,\n    watchFolders: metroConfig.watchFolders,\n  });\n\n  const customEnhanceMiddleware = metroConfig.server.enhanceMiddleware;\n  // @ts-ignore can't mutate readonly config\n  metroConfig.server.enhanceMiddleware = (metroMiddleware: any, server: Metro.Server) => {\n    if (customEnhanceMiddleware) {\n      metroMiddleware = customEnhanceMiddleware(metroMiddleware, server);\n    }\n    return middleware.use(metroMiddleware);\n  };\n\n  middleware.use(createDebuggerTelemetryMiddleware(projectRoot, exp));\n\n  const server = await Metro.runServer(metroConfig, {\n    hmrEnabled: true,\n    websocketEndpoints,\n    // @ts-expect-error Property was added in 0.73.4, remove this statement when updating Metro\n    watch: isWatchEnabled(),\n  });\n\n  if (attachToServer) {\n    // Expo SDK 44 and lower\n    const { messageSocket, eventsSocket } = attachToServer(server);\n    reportEvent = eventsSocket.reportEvent;\n\n    return {\n      server,\n      middleware,\n      messageSocket,\n    };\n  } else {\n    // RN +68 -- Expo SDK +45\n    reportEvent = eventsSocketEndpoint.reportEvent;\n\n    return {\n      server,\n      middleware,\n      messageSocket: messageSocketEndpoint,\n    };\n  }\n}\n\n/**\n * Simplify and communicate if Metro is running without watching file updates,.\n * Exposed for testing.\n */\nexport function isWatchEnabled() {\n  if (env.CI) {\n    Log.log(\n      chalk`Metro is running in CI mode, reloads are disabled. Remove {bold CI=true} to enable watch mode.`\n    );\n  }\n\n  return !env.CI;\n}\n"],"names":["instantiateMetroAsync","isWatchEnabled","projectRoot","options","reportEvent","Metro","importMetroFromProject","ExpoMetroConfig","importExpoMetroConfigFromProject","terminal","Terminal","process","stdout","terminalReporter","MetroTerminalReporter","reporter","update","event","metroConfig","loadAsync","exp","getConfig","skipSDKVersionRequirement","skipPlugins","platformBundlers","getPlatformBundlers","withMetroMultiPlatformAsync","logEventAsync","getMetroProperties","middleware","attachToServer","websocketEndpoints","eventsSocketEndpoint","messageSocketEndpoint","createDevServerMiddleware","port","server","watchFolders","customEnhanceMiddleware","enhanceMiddleware","metroMiddleware","use","createDebuggerTelemetryMiddleware","runServer","hmrEnabled","watch","messageSocket","eventsSocket","env","CI","Log","log","chalk"],"mappings":"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"}